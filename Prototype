import glob
from PyPDF2 import PdfFileReader, PdfFileWriter
import pandas as pd
from tkinter import *
import tkinter as tk
from tkinter import ttk

#Read the file
df = pd.read_excel(r'C:/Users/BIDN/PycharmProjects/Hydraulics.xlsx', sheet_name='Third proposal', skipinitialspace=True)

#Drop all NaN values
df = df.dropna(axis=0, how='all', thresh=None, subset=None, inplace=False)
df.reset_index(drop=False)

PartnoList = df['Part no']
MakersList = df['Maker choice']

#setting the labels to look for

list_of_HPS_types = ['HPS gear driven','HPS gear driven - THS2','HPS el driven']

#Groups by column for group, if it has at least 1 item
groups_parts = df.groupby(['Group', 'Category'])
groupsList = []
groupGroup = []

listGRoupmakers = df['Maker choice'].groupby(df['Group']).apply(list).reset_index(name='Brands')
listMakers = listGRoupmakers['Brands'].tolist()

#---------GUI-----------

root = tk.Tk()
root.title("Hydraulics GUI")

categories = df['Category'].unique().tolist()

for (i, item) in enumerate(categories):
    if "HPS" in item:
        categories[i] = "HPS"

categories = pd.DataFrame(categories, columns =['Category'])
categories = categories['Category'].unique().tolist()

#Dictionary to dynamically declare variables

d={}
listIndexVariables = []
listVariables = []
XVariables = []
for x in range(len(listMakers)):
        d["Var{0}".format(x)] = tk.StringVar()
        XVariables.append(d)

for key, value in d.items():
        temp = [key, value]
        listVariables.append(temp[1])
print("listIndexVariables", listIndexVariables)

r = 0
answers = []
for c in categories:
    ttk.Label(text=c, relief=tk.RIDGE, width=15).grid(row=r,column=0)
    categoriesParts = ttk.Combobox(root, textvariable = listVariables[r], values=listMakers[r],width=10, state="readonly").grid(row=r,column=1)
    r = r + 1

partNoList = []

zippedList = list(zip(PartnoList, MakersList))

Makers = df['Maker choice']

#PDFs: read selection from answers, then look what file nr it is and look for that in directory

paths = []

def merge_pdfs(paths, output):
    for x in range(len(listMakers)):
        answers.append(listVariables[x].get())
    indexMakerChoice = df.index[df['Maker choice'].isin(answers)].tolist()
    print("indexMakerChoice", indexMakerChoice)
    print("answers", answers)
    listPartNo = df.loc[indexMakerChoice, 'Part no'].tolist()
    print("listPartNo", listPartNo)
    #for file_name in os.listdir('C:/Users/BIDN/PycharmProjects'):
    patterns = [s + '.pdf' for s in listPartNo]
    for pattern in patterns:
        for fn in glob.glob(pattern):
            paths.append(fn)
    print("paths", paths)
    answers.clear()

    ##############PDFS
    pdf_writer = PdfFileWriter()
    # pdf_writer.addPage('')

    for path in paths:
        pdf_reader = PdfFileReader(path)
        # pdf_reader.addBlankPage()
        for page in range(pdf_reader.getNumPages()):
            # Add each page to the writer object
            pdf_writer.addPage(pdf_reader.getPage(page))

    # Write out the merged PDF
    with open(output, 'wb') as out:
        pdf_writer.write(out)

    # Clear the files list after configuring
    paths.clear()

print(partNoList.index)

browseButton_Excel = tk.Button(text='Print Config', command=lambda : merge_pdfs(paths, output='HydraulicPartsMerged.pdf'), bg='green', fg='white')
browseButton_Excel.grid(column=2, row=50)

answers.clear()

mainloop()
